YUI.add("moodle-mod_bigbluebuttonbn-broker",function(e,t){M.mod_bigbluebuttonbn=M.mod_bigbluebuttonbn||{},M.mod_bigbluebuttonbn.broker={data_source:null,polling:null,bigbluebuttonbn:{},init:function(t){this.data_source=new e.DataSource.Get({source:M.cfg.wwwroot+"/mod/bigbluebuttonbn/bbb_broker.php?"}),this.bigbluebuttonbn=t},waitModerator:function(){var t=e.one("#status_bar_span"),n=e.DOM.create("<img>");e.DOM.setAttribute(n,"id","spinning_wheel"),e.DOM.setAttribute(n,"src","pix/processing16.gif"),e.DOM.addHTML(t,"&nbsp;"),e.DOM.addHTML(t,n);var r="action=meeting_info";r+="&id="+this.bigbluebuttonbn.meetingid,r+="&bigbluebuttonbn="+this.bigbluebuttonbn.bigbluebuttonbnid,this.polling=this.data_source.setInterval(this.bigbluebuttonbn.ping_interval,{request:r,callback:{success:function(e){e.data.running&&(clearInterval(this.polling),M.mod_bigbluebuttonbn.view_clean(),M.mod_bigbluebuttonbn.view_update())},failure:function(){clearInterval(this.polling)}}})},joinNow:function(t,n,r){var i="";r?(e.one("#panelContent").removeClass("hidden"),i+="action=meeting_info",i+="&id="+this.bigbluebuttonbn.meetingid,i+="&bigbluebuttonbn="+this.bigbluebuttonbn.bigbluebuttonbnid,this.data_source.sendRequest({request:i,callback:{success:function(n){n.data.running?M.mod_bigbluebuttonbn.broker.executeJoin(t,n.data.status.message):(e.one("#meeting_join_url").set("value",t),e.one("#meeting_message").set("value",n.data.status.message),YUI({lang:this.bigbluebuttonbn.locale}).use("panel",function(){bigbluebuttonbn_panel.show()}))}}})):M.mod_bigbluebuttonbn.broker.executeJoin(t)},executeJoin:function(e){window.open(e),setTimeout(function(){M.mod_bigbluebuttonbn.view_clean(),M.mod_bigbluebuttonbn.view_update()},15e3)},actionVerification:function(t,n,r,i){var s=e.one("#playbacks-"+n).get("dataset").imported==="true",o={id:n},u;!!s||t!=="unpublish"&&t!=="delete"?t==="import"?(u=new M.core.confirm({modal:!0,centered:!0,question:this.bigbluebuttonbn.locales.import_confirmation}),u.on("complete-yes",function(e,t){e.confirmed=!0,t(e)},this)):(o.confirmed=!0,i(o)):this.data_source.sendRequest({request:"action=recording_links&id="+n,callback:{success:function(e){if(e.data.status){o.links=e.data.links;if(e.data.links===0)o.confirmed=!0;else{var n=this.bigbluebuttonbn.locales[t+"_confirmation_warning_p"];e.data.links==1&&(n=this.bigbluebuttonbn.locales[t+"_confirmation_warning_s"]),n=n.replace("{$a}",e.data.links)+". ";var r=this.bigbluebuttonbn.locales.recording;s&&(r=this.bigbluebuttonbn.locales.recording_link);var a=this.bigbluebuttonbn.locales[t+"_confirmation"];a=a.replace("{$a}",r),u=new M.core.confirm({modal:!0,centered:!0,question:n+"\n\n"+a}),u.on("complete-yes",function(e,t){e.confirmed=!0,t(e)},this)}}else o.error="Big failiure";i(o)},failure:function(e){o.error=e.error.message,i(o)}}})},manageRecording:function(t,n,r){M.mod_bigbluebuttonbn.broker.actionVerification(t,n,r,function(i){i.confirmed&&this.data_source.sendRequest({request:"action=recording_"+t+"&id="+n,callback:{success:function(i){if(t=="delete")e.one("#recording-td-"+n).remove();else if(t=="import")e.one("#recording-td-"+n).remove();else if(t=="publish"||t=="unpublish")if(i.data.status=="true"){var s={action:t,meetingid:r,recordingid:n};this.polling=this.data_source.setInterval(this.bigbluebuttonbn.ping_interval,M.mod_bigbluebuttonbn.broker.pingRecordingObject(s))}else{var o=new M.core.alert({message:i.data.message});o.show()}}}})})},pingRecordingObject:function(t){var n=e.one("#recording-btn-"+t.action+"-"+t.recordingid),r=n.getAttribute("src"),i=r.substring(0,r.length-4);n.setAttribute("src",M.cfg.wwwroot+"/mod/bigbluebuttonbn/pix/processing16.gif"),t.action=="publish"?(n.setAttribute("alt",this.bigbluebuttonbn.locales.publishing),n.setAttribute("title",this.bigbluebuttonbn.locales.publishing)):(n.setAttribute("alt",this.bigbluebuttonbn.locales.unpublishing),n.setAttribute("title",this.bigbluebuttonbn.locales.unpublishing));var s=e.one("#recording-link-"+t.action+"-"+t.recordingid),o=s.getAttribute("onclick");return s.setAttribute("onclick",""),{request:"action=recording_info&id="+t.recordingid+"&idx="+t.meetingid,callback:{success:function(r){if(r.data.status!=="true"){clearInterval(this.polling);return}if(t.action==="publish"&&r.data.published==="true"){clearInterval(this.polling),n.setAttribute("id","recording-btn-unpublish-"+t.recordingid),s.setAttribute("id","recording-link-unpublish-"+t.recordingid),n.setAttribute("src",i+"hide"),n.setAttribute("alt",this.bigbluebuttonbn.locales.unpublish),n.setAttribute("title",this.bigbluebuttonbn.locales.unpublish),s.setAttribute("onclick",o.replace("publish","unpublish")),e.one("#playbacks-"+t.recordingid).show();return}t.action==="unpublish"&&r.data.published==="false"&&(clearInterval(this.polling),n.setAttribute("id","recording-btn-publish-"+t.recordingid),s.setAttribute("id","recording-link-publish-"+t.recordingid),n.setAttribute("src",i+"show"),n.setAttribute("alt",this.bigbluebuttonbn.locales.publish),n.setAttribute("title",this.bigbluebuttonbn.locales.publish),s.setAttribute("onclick",o.replace("unpublish","publish")),e.one("#playbacks-"+t.recordingid).hide())},failure:function(){clearInterval(this.polling)}}}},endMeeting:function(){var e="action=meeting_end&id="+this.bigbluebuttonbn.meetingid;e+="&bigbluebuttonbn="+this.bigbluebuttonbn.bigbluebuttonbnid,this.data_source.sendRequest({request:e,callback:{success:function(e){e.data.status&&(M.mod_bigbluebuttonbn.view_clean_control_panel(),M.mod_bigbluebuttonbn.view_hide_join_button(),M.mod_bigbluebuttonbn.view_hide_end_button(),location.reload())}}})}}},"@VERSION@",{requires:["base","node"]});
