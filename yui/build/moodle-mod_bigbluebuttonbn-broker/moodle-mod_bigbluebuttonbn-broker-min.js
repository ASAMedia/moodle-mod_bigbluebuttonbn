YUI.add("moodle-mod_bigbluebuttonbn-broker",function(e,t){M.mod_bigbluebuttonbn=M.mod_bigbluebuttonbn||{},M.mod_bigbluebuttonbn.broker={datasource:null,bigbluebuttonbn:{},init:function(t){this.datasource=new e.DataSource.Get({source:M.cfg.wwwroot+"/mod/bigbluebuttonbn/bbb_broker.php?"}),this.bigbluebuttonbn=t},join_redirect:function(e){window.open(e)},recording_import:function(t){var n=new M.core.confirm({modal:!0,centered:!0,question:this.recording_confirmation_message("import",t.recordingid)});n.on("complete-yes",function(){this.datasource.sendRequest({request:"action=recording_import&id="+t.recordingid,callback:{success:function(){e.one("#recording-td-"+t.recordingid).remove()}}})},this)},recording_action_perform:function(e){this.datasource.sendRequest({request:"action=recording_"+e.action+"&id="+e.recordingid,callback:{success:function(t){return t.data.status?M.mod_bigbluebuttonbn.broker.recording_action_performed({attempt:1,action:e.action,meetingid:e.meetingid,recordingid:e.recordingid,goalstate:e.goalstate}):(e.message=t.data.message,M.mod_bigbluebuttonbn.recordings.recording_action_failed(e))},failure:function(t){return e.message=t.error.message,M.mod_bigbluebuttonbn.recordings.recording_action_failed(e)}}})},recording_action_performed:function(e){this.datasource.sendRequest({request:"action=recording_info&id="+e.recordingid+"&idx="+e.meetingid,callback:{success:function(t){var n=M.mod_bigbluebuttonbn.broker.recording_current_state(e.action,t.data);return n===null?(e.message=M.util.get_string("view_error_current_state_not_found","bigbluebuttonbn"),M.mod_bigbluebuttonbn.recordings.recording_action_failed(e)):n===e.goalstate?M.mod_bigbluebuttonbn.recordings.recording_action_completed(e):e.attempt<5?(e.attempt+=1,setTimeout(function(){return function(){M.mod_bigbluebuttonbn.broker.recording_action_performed(e)}}(this),(e.attempt-1)*1e3)):(e.message=M.util.get_string("view_error_action_not_completed","bigbluebuttonbn"),M.mod_bigbluebuttonbn.recordings.recording_action_failed(e))},failure:function(t){return e.message=t.error.message,M.mod_bigbluebuttonbn.recordings.recording_action_failed(e)}}})},recording_current_state:function(e,t){return e==="publish"||e==="unpublish"?t.published:e==="delete"?t.status:e==="secure"||e==="unsecure"?t.secured:e==="update"?t.updated:null},end_meeting:function(){var e="action=meeting_end&id="+this.bigbluebuttonbn.meetingid;e+="&bigbluebuttonbn="+this.bigbluebuttonbn.bigbluebuttonbnid,this.datasource.sendRequest({request:e,callback:{success:function(e){e.data.status&&(M.mod_bigbluebuttonbn.rooms.clean_control_panel(),M.mod_bigbluebuttonbn.rooms.hide_join_button(),M.mod_bigbluebuttonbn.rooms.hide_end_button(),location.reload())}}})}}},"@VERSION@",{requires:["base","node","datasource-get","datasource-jsonschema","datasource-polling","moodle-core-notification"]});
